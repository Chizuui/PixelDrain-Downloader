name: Mirror (Pipe Separator) -> PixelDrain

on:
  workflow_dispatch:
    inputs:
      urls:
        description: "Masukkan URL dipisah dengan tanda '|' (contoh: url1 | url2 | url3)"
        required: true
        type: string
        default: "https://example.com/file1.zip | https://example.com/file2.apk"

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq

      - name: Process, Download, and Upload
        id: process
        run: |
          mkdir -p downloads
          
          # ================= LOGIKA PEMISAH (PIPE SPLITTER) =================
          # 1. echo input
          # 2. tr '|' '\n': Ubah semua tanda pipa menjadi Enter (baris baru)
          # 3. sed ...: Hapus spasi di depan/belakang URL (trim whitespace)
          # 4. sed '/^$/d': Hapus baris kosong jika ada
          
          echo "${{ github.event.inputs.urls }}" | tr '|' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' > url_list.txt
          
          # Cek isi list (untuk debug di log)
          echo "Daftar URL yang akan diproses:"
          cat url_list.txt
          echo "--------------------------------"

          # Siapkan Summary Table
          echo "## Mirror Report" >> "$GITHUB_STEP_SUMMARY"
          echo "| File Name | Status | PixelDrain Link |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- | --- |" >> "$GITHUB_STEP_SUMMARY"

          # Loop baca per baris
          while IFS= read -r URL; do
            echo "Processing: $URL"
            
            # Ambil nama file asli atau generate random jika tidak ada
            FILE_NAME="$(basename "${URL%%\?*}")"
            if [ -z "$FILE_NAME" ] || [ "$FILE_NAME" = "/" ]; then
              FILE_NAME="file_$(date +%s%N).bin"
            fi

            echo "Downloading $FILE_NAME..."
            
            # Download dengan Aria2
            aria2c \
              --max-connection-per-server=4 \
              --split=4 \
              --retry-wait=5 \
              --max-tries=5 \
              --user-agent="Mozilla/5.0 (Linux; Android 10)" \
              --header="Referer: https://www.biligame.com/" \
              -d downloads -o "$FILE_NAME" "$URL"

            if [ $? -eq 0 ]; then
              echo "Uploading $FILE_NAME to PixelDrain..."
              
              # Upload ke PixelDrain
              RESPONSE=$(curl -sS -u :${{ secrets.PIXELDRAIN_API_KEY }} -T "downloads/$FILE_NAME" https://pixeldrain.com/api/file/)
              
              ID=$(echo "$RESPONSE" | jq -r '.id // empty')
              
              if [ -n "$ID" ]; then
                LINK="https://pixeldrain.com/u/$ID"
                echo "| $FILE_NAME | ✅ Success | [Download]($LINK) |" >> "$GITHUB_STEP_SUMMARY"
                echo "Success Link: $LINK"
              else
                echo "| $FILE_NAME | ❌ Upload Failed | - |" >> "$GITHUB_STEP_SUMMARY"
              fi
            else
              echo "| $FILE_NAME | ❌ Download Failed | - |" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            # Hapus file lokal untuk menghemat storage runner
            if [ -f "downloads/$FILE_NAME" ]; then
                rm "downloads/$FILE_NAME"
            fi
            
          done < url_list.txt

      - name: Done
        run: echo "Semua proses selesai."
