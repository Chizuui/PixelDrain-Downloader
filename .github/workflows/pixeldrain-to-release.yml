name: Mirror biligame apk -> PixelDrain

on:
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl

      # ====== DIAGNOSTIC ======
      - name: Check URL headers (diagnostic)
        run: |
          URL="https://pkg.biligame.com/games/mrfz_2.6.91_20251219_100755_ab244.apk"
          curl -I -L "$URL" \
            -A "Mozilla/5.0 (Linux; Android 10)" \
            -e "https://www.biligame.com/" \
            || true

      # ====== DOWNLOAD ======
      - name: Download APK (polite aria2)
        run: |
          URL="https://pkg.biligame.com/games/mrfz_2.6.91_20251219_100755_ab244.apk"
          FILE="mrfz_2.6.91_20251219_100755_ab244.apk"

          aria2c \
            --max-connection-per-server=1 \
            --split=1 \
            -j 1 \
            --retry-wait=5 \
            --max-tries=10 \
            --timeout=60 \
            --connect-timeout=30 \
            --user-agent="Mozilla/5.0 (Linux; Android 10)" \
            --header="Referer: https://www.biligame.com/" \
            --header="Origin: https://www.biligame.com" \
            -o "$FILE" "$URL"

          ls -lh "$FILE"

      # ====== PIXELDRAIN ======
      - name: Upload to PixelDrain
        env:
          PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
        run: |
          FILE="mrfz_2.6.91_20251219_100755_ab244.apk"

          echo "Uploading to PixelDrain..."
          RESPONSE=$(curl -s \
            -u :$PIXELDRAIN_API_KEY \
            -T "$FILE" \
            https://pixeldrain.com/api/file/)

          echo "PixelDrain response:"
          echo "$RESPONSE"

      - name: Done
        run: echo "Mirror selesai (Google Drive + PixelDrain)"
