name: Mirror (Torrent/Magnet/Telegram) -> PixelDrain (universal URL)

on:
  workflow_dispatch:
    inputs:
      source:
        description: "Pilih sumber: url | magnet | torrent_url | telegram_file_id"
        required: true
        default: "magnet"
      input:
        description: "Isi sesuai source"
        required: true
      filename:
        description: "Optional custom filename"
        required: false
        default: ""

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq python3 zip

      - name: Prepare variables
        id: vars
        shell: bash
        run: |
          SRC="${{ inputs.source }}"
          INP="${{ inputs.input }}"
          CUSTOM="${{ inputs.filename }}"

          AUTO="download.bin"
          if [ "$SRC" = "url" ]; then
            AUTO="$(basename "${INP%%\?*}")"
          elif [ "$SRC" = "magnet" ]; then
            AUTO="magnet_download"
          elif [ "$SRC" = "torrent_url" ]; then
            AUTO="torrent_download"
          elif [ "$SRC" = "telegram_file_id" ]; then
            AUTO="telegram_download.bin"
          fi

          FILE="${CUSTOM:-$AUTO}"

          echo "src=$SRC" >> $GITHUB_OUTPUT
          echo "inp=$INP" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT

      # ===== DIRECT URL =====
      - name: Download direct URL
        if: steps.vars.outputs.src == 'url'
        run: |
          aria2c -o "${{ steps.vars.outputs.file }}" "${{ steps.vars.outputs.inp }}"

      # ===== MAGNET =====
      - name: Download magnet
        if: steps.vars.outputs.src == 'magnet'
        run: |
          mkdir out
          aria2c \
            --seed-time=0 \
            --follow-torrent=mem \
            --bt-stop-timeout=60 \
            --enable-dht=true \
            --enable-peer-exchange=true \
            --bt-enable-lpd=true \
            -d out \
            "${{ steps.vars.outputs.inp }}"

      # ===== TORRENT URL =====
      - name: Download torrent file
        if: steps.vars.outputs.src == 'torrent_url'
        run: |
          mkdir out
          curl -L -o file.torrent "${{ steps.vars.outputs.inp }}"
          aria2c --seed-time=0 -d out file.torrent

      # ===== TELEGRAM (file_id) =====
      - name: Download Telegram file (file_id)
        if: steps.vars.outputs.src == 'telegram_file_id'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          FILE_ID: ${{ steps.vars.outputs.inp }}
          OUTFILE: ${{ steps.vars.outputs.file }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN"
            exit 1
          fi

          python3 << 'PY'
          import json, urllib.request, os, sys

          token = os.environ["TELEGRAM_BOT_TOKEN"]
          file_id = os.environ["FILE_ID"]
          out = os.environ["OUTFILE"]

          api = f"https://api.telegram.org/bot{token}/getFile?file_id={file_id}"
          data = json.loads(urllib.request.urlopen(api).read())

          if not data.get("ok"):
              print(data)
              sys.exit(1)

          path = data["result"]["file_path"]
          url = f"https://api.telegram.org/file/bot{token}/{path}"
          urllib.request.urlretrieve(url, out)
          print("Saved:", out)
          PY

      # ===== SELECT TARGET =====
      - name: Prepare upload file
        id: pick
        run: |
          if [ "${{ steps.vars.outputs.src }}" = "url" ] || \
             [ "${{ steps.vars.outputs.src }}" = "telegram_file_id" ]; then
            echo "target=${{ steps.vars.outputs.file }}" >> $GITHUB_OUTPUT
          else
            zip -r torrent_payload.zip out
            echo "target=torrent_payload.zip" >> $GITHUB_OUTPUT
          fi

      # ===== PIXELDRAIN =====
      - name: Upload to PixelDrain
        env:
          PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
        run: |
          FILE="${{ steps.pick.outputs.target }}"

          RESP=$(curl -s \
            -u :$PIXELDRAIN_API_KEY \
            -T "$FILE" \
            https://pixeldrain.com/api/file/)

          echo "$RESP" | jq .

          ID=$(echo "$RESP" | jq -r '.id')
          echo "## PixelDrain" >> $GITHUB_STEP_SUMMARY
          echo "- File: $FILE" >> $GITHUB_STEP_SUMMARY
          echo "- Link: https://pixeldrain.com/u/$ID" >> $GITHUB_STEP_SUMMARY

      - name: Done
        run: echo "Mirror selesai âœ…"
