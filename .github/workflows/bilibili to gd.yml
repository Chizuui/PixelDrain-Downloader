name: Mirror biligame apk -> Google Drive

on:
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl

      - name: Write Service Account JSON
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
        run: |
          echo "$GDRIVE_SA_JSON" > sa.json
          test -s sa.json

      # Diagnostik: lihat status dari GitHub runner (berguna kalau masih 403)
      - name: Check URL headers (diagnostic)
        run: |
          URL="https://pkg.biligame.com/games/mrfz_2.6.91_20251219_100755_ab244.apk"
          echo "Testing HEAD response..."
          curl -I -L "$URL" \
            -A "Mozilla/5.0 (Linux; Android 10) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36" \
            -e "https://www.biligame.com/" \
            || true

      - name: Download APK (polite aria2 settings)
        run: |
          URL="https://pkg.biligame.com/games/mrfz_2.6.91_20251219_100755_ab244.apk"
          OUT="mrfz_2.6.91_20251219_100755_ab244.apk"

          aria2c \
            --max-connection-per-server=1 \
            --split=1 \
            -j 1 \
            --retry-wait=5 \
            --max-tries=10 \
            --timeout=60 \
            --connect-timeout=30 \
            --user-agent="Mozilla/5.0 (Linux; Android 10) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36" \
            --header="Referer: https://www.biligame.com/" \
            --header="Origin: https://www.biligame.com" \
            -o "$OUT" "$URL"

          ls -lh "$OUT"

      - name: Setup rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          cat > rclone.conf <<'EOF'
          [gdrive]
          type = drive
          scope = drive
          service_account_file = sa.json
          EOF

      - name: Upload to Google Drive folder
        env:
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          FILE="mrfz_2.6.91_20251219_100755_ab244.apk"

          rclone --config rclone.conf copy "$FILE" "gdrive:{${FOLDER_ID}}" \
            --drive-chunk-size 64M \
            --transfers 1 \
            --checkers 4 \
            -P

      - name: Done
        run: echo "Upload selesai."
