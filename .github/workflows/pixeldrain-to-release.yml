name: Mirror file -> PixelDrain (universal URL)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Direct download URL (contoh: https://example.com/file.apk)"
        required: true
        default: "https://pkg.biligame.com/games/mrfz_2.6.91_20251219_100755_ab244.apk"
      filename:
        description: "Optional: custom filename (kosongkan untuk auto dari URL)"
        required: false
        default: ""

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq

      - name: Set variables
        id: vars
        run: |
          URL="${{ inputs.url }}"
          CUSTOM_NAME="${{ inputs.filename }}"

          # ambil nama file dari URL (tanpa querystring)
          AUTO_NAME="$(basename "${URL%%\?*}")"
          if [ -z "$AUTO_NAME" ] || [ "$AUTO_NAME" = "/" ]; then
            AUTO_NAME="download.bin"
          fi

          if [ -n "$CUSTOM_NAME" ]; then
            FILE="$CUSTOM_NAME"
          else
            FILE="$AUTO_NAME"
          fi

          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

          echo "URL: $URL"
          echo "FILE: $FILE"

      # ====== DIAGNOSTIC (opsional) ======
      - name: Check URL headers (diagnostic)
        run: |
          URL="${{ steps.vars.outputs.url }}"
          curl -I -L "$URL" \
            -A "Mozilla/5.0 (Linux; Android 10)" \
            -e "https://www.biligame.com/" \
            || true

      # ====== DOWNLOAD ======
      - name: Download (polite aria2)
        run: |
          URL="${{ steps.vars.outputs.url }}"
          FILE="${{ steps.vars.outputs.file }}"

          aria2c \
            --max-connection-per-server=1 \
            --split=1 \
            -j 1 \
            --retry-wait=5 \
            --max-tries=10 \
            --timeout=60 \
            --connect-timeout=30 \
            --user-agent="Mozilla/5.0 (Linux; Android 10)" \
            --header="Referer: https://www.biligame.com/" \
            --header="Origin: https://www.biligame.com" \
            -o "$FILE" "$URL"

          ls -lh "$FILE"

      # ====== PIXELDRAIN UPLOAD + PRINT LINK (FIXED) ======
      - name: Upload to PixelDrain and print link
        env:
          PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
        run: |
          FILE="${{ steps.vars.outputs.file }}"

          if [ -z "$PIXELDRAIN_API_KEY" ]; then
            echo "Missing secret PIXELDRAIN_API_KEY"
            exit 1
          fi

          echo "Uploading to PixelDrain..."
          RESPONSE="$(curl -sS \
            -u :$PIXELDRAIN_API_KEY \
            -T "$FILE" \
            https://pixeldrain.com/api/file/)"

          # Pretty print JSON (kalau gagal parse, print raw)
          echo "$RESPONSE" | jq . || echo "$RESPONSE"

          # Sukses kalau ada ID
          ID="$(echo "$RESPONSE" | jq -r '.id // empty')"
          SHA256="$(echo "$RESPONSE" | jq -r '.hash_sha256 // empty')"
          SIZE="$(echo "$RESPONSE" | jq -r '.size // empty')"

          if [ -z "$ID" ]; then
            echo "PixelDrain upload failed: missing id"
            exit 1
          fi

          LINK="https://pixeldrain.com/u/$ID"
          echo "PixelDrain link: $LINK"

          # Simpan ke step summary
          {
            echo "## PixelDrain Upload Result"
            echo ""
            echo "- **File:** \`$FILE\`"
            echo "- **Link:** $LINK"
            if [ -n "$SIZE" ]; then
              echo "- **Size:** $SIZE bytes"
            fi
            if [ -n "$SHA256" ]; then
              echo "- **SHA256:** \`$SHA256\`"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Done
        run: echo "Mirror selesai (PixelDrain)"
